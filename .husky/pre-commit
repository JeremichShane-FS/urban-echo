#!/bin/sh

# =================================================================
# HUSKY PRE-COMMIT HOOK - E-COMMERCE PLATFORM
# =================================================================
# Purpose: Enforces code quality standards before each commit
# Runs: ESLint, Prettier formatting, and lint-staged checks
# Prevents: Commits that don't meet project quality standards
# 
# This hook ensures all code meets professional standards before
# being committed to the repository, maintaining code consistency
# across the entire e-commerce development team.
# =================================================================

echo "ğŸ” Starting pre-commit quality checks..."
echo "ğŸ“‹ Validating staged files for code standards..."

# =================================================================
# PRETTIER CONFIGURATION SETUP
# =================================================================
# Create temporary Prettier config from project configuration
# This ensures consistent formatting across all staged files
# Uses the centralized prettier-config.js for consistency
#
# NOTE: Ensure .prettier.temp.json is in .gitignore to prevent
# accidental commits of this temporary configuration file

echo "âš™ï¸  Setting up Prettier configuration..."

node --input-type=module -e "
import fs from 'fs';
import { prettierConfig } from './scripts/prettier-config.js';
fs.writeFileSync('.prettier.temp.json', JSON.stringify(prettierConfig, null, 2));
" || { 
  echo 'âŒ Failed to create temporary Prettier config'
  echo 'ğŸ’¡ Ensure scripts/prettier-config.js exists and is valid'
  echo 'ğŸ’¡ Verify .prettier.temp.json is in .gitignore'
  exit 1
}

echo "âœ… Prettier configuration loaded successfully"

# =================================================================
# LINT-STAGED EXECUTION
# =================================================================
# Run lint-staged to process only staged files
# This includes: ESLint fixes, Prettier formatting, type checking
# --allow-empty: Prevents failure when no files are staged

echo "ğŸ§¹ Running lint-staged on staged files..."
echo "   â†’ ESLint: Checking code quality and fixing auto-fixable issues"
echo "   â†’ Prettier: Formatting code for consistency"
echo "   â†’ Type checking: Validating TypeScript/JSDoc types"

npx lint-staged --allow-empty || {
  echo ""
  echo "âŒ Lint-staged checks failed!"
  echo "ğŸ’¡ Fix the issues above before committing"
  echo "ğŸ’¡ Run 'npm run lint:fix' to auto-fix some issues"
  echo "ğŸ’¡ Run 'npm run format' to fix formatting issues"
  echo "ğŸ’¡ Temporary config will be cleaned up automatically"
  exit 1
}

# =================================================================
# CLEANUP AND SUCCESS
# =================================================================
# Remove temporary Prettier configuration file
# Report successful completion of all quality checks

echo "ğŸ§¹ Cleaning up temporary Prettier configuration..."
rm -f .prettier.temp.json

echo ""
echo "âœ… All pre-commit checks passed successfully!"
echo "ğŸš€ Your code meets quality standards and is ready for commit"
echo "ğŸ“¦ Staged files have been formatted and validated"
echo ""