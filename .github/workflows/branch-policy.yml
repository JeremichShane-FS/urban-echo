# =================================================================
# BRANCH POLICY ENFORCEMENT WORKFLOW
# =================================================================
# Purpose: Enforces Git workflow standards for production deployments
# Trigger: Pull requests targeting the main (production) branch
# Policy: Only staging branch can merge into main branch
#
# This workflow ensures proper deployment flow:
# feature/dev â†’ staging â†’ main (production)
#
# Benefits:
# - Prevents direct commits to production
# - Ensures all changes go through staging testing
# - Maintains stable production environment
# - Enforces proper code review process
# =================================================================

name: "Branch Policy Enforcement"

# Only runs on pull requests targeting the main branch
# This prevents accidental direct commits to production
on:
  pull_request:
    branches: [main]

jobs:
  # =================================================================
  # VALIDATE PULL REQUEST SOURCE BRANCH
  # =================================================================
  # Ensures that only the staging branch can create PRs to main
  # This enforces the proper deployment pipeline and prevents
  # feature branches from accidentally deploying to production

  check-source-branch:
    name: "Validate PR Source Branch"
    runs-on: ubuntu-latest

    steps:
      - name: "Enforce Staging-to-Main Policy"
        run: |
          echo "ğŸ” Checking pull request source branch..."
          echo "ğŸ“‹ Current PR: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
          echo ""

          # Verify that the source branch is 'staging'
          if [[ "${{ github.head_ref }}" != "staging" ]]; then
            echo "âŒ BRANCH POLICY VIOLATION"
            echo ""
            echo "ğŸš« Pull requests to 'main' branch must originate from 'staging' branch only"
            echo "ğŸ“ Current source branch: '${{ github.head_ref }}'"
            echo "âœ… Required source branch: 'staging'"
            echo ""
            echo "ğŸ”§ To fix this issue:"
            echo "   1. Merge your changes into the 'staging' branch first"
            echo "   2. Test thoroughly in staging environment"
            echo "   3. Create a new PR from 'staging' to 'main'"
            echo ""
            echo "ğŸ“– Deployment flow: feature â†’ staging â†’ main"
            echo ""
            exit 1
          fi

          echo "âœ… BRANCH POLICY COMPLIANCE"
          echo "ğŸ‰ Pull request source branch 'staging' is valid"
          echo "ğŸš€ This PR follows proper deployment workflow"
          echo ""
          echo "ğŸ“‹ Deployment Pipeline Status:"
          echo "   âœ… Feature development completed"
          echo "   âœ… Staging branch testing completed"
          echo "   ğŸ”„ Ready for production deployment review"
