# =================================================================
# INFRASTRUCTURE-LEVEL ENFORCEMENT WORKFLOW
# =================================================================
# Purpose: Enforces security, quality, and standards at the CI/CD level
# Triggers: All pushes and pull requests on any branch
# Enforcement: Security scanning, code quality, build verification, TODO standards
#
# This workflow provides multiple security and quality gates:
# 1. Security scanning for sensitive data and dangerous patterns
# 2. Code quality enforcement through ESLint
# 3. Build verification to ensure deployability
# 4. Dependency vulnerability scanning
# 5. TODO/FIX comment standards enforcement
#
# These checks run on every push to prevent security issues and
# maintain code quality standards across the entire project.
# =================================================================

name: "Infrastructure-Level Enforcement"

# Runs on all branches for comprehensive protection
# Ensures no branch can bypass security and quality checks
on:
  push:
    branches: ["**"] # All push events on any branch
  pull_request:
    branches: ["**"] # All pull requests targeting any branch

# Required permissions for security scanning and content analysis
permissions:
  security-events: write # Required for security scanning and reporting
  contents: read # Required to read repository content for analysis

jobs:
  # =================================================================
  # JOB 1: CORE SECURITY AND QUALITY ENFORCEMENT
  # =================================================================
  # Primary enforcement job that validates security, quality, and buildability
  # This job must pass for any code to be merged or deployed

  build:
    name: "Security & Quality Gate"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Repository with Full History"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive security scanning

      - name: "Setup Node.js Environment"
        uses: actions/setup-node@v4
        with:
          node-version: "18" # LTS version for stability
          cache: "npm" # Cache dependencies for faster builds

      # =================================================================
      # SECURITY SCANNING GATE
      # =================================================================
      # Scans codebase for security vulnerabilities and sensitive data
      # Prevents commits containing secrets, API keys, or dangerous patterns

      - name: "Security Vulnerability Scanning"
        run: |
          echo "ğŸ”’ Starting comprehensive security scan..."
          echo "ğŸ” Scanning for sensitive data and dangerous code patterns..."
          echo ""

          # =================================================================
          # STRIPE API KEY DETECTION
          # =================================================================
          # Prevents secret Stripe keys from being committed to repository
          # Pattern: sk_ followed by at least 20 alphanumeric characters

          echo "ğŸ’³ Checking for Stripe secret keys..."
          if grep -r "sk_[a-zA-Z0-9]\{20,\}" src/ 2>/dev/null; then
            echo ""
            echo "âŒ CRITICAL SECURITY VIOLATION: Stripe secret key detected"
            echo "ğŸš¨ Secret API keys must never be committed to version control"
            echo ""
            echo "ğŸ”§ Immediate actions required:"
            echo "   1. Remove the secret key from all files"
            echo "   2. Add key to .env.local (excluded from git)"
            echo "   3. Use process.env.STRIPE_SECRET_KEY in code"
            echo "   4. Rotate the compromised key in Stripe dashboard"
            echo ""
            exit 1
          fi
          echo "   âœ… No Stripe secret keys found"

          # =================================================================
          # PUBLIC API KEY DETECTION
          # =================================================================
          # Detects public API keys that might be exposed unintentionally
          # Pattern: pk_ followed by at least 20 alphanumeric characters

          echo "ğŸ”‘ Checking for exposed public API keys..."
          if grep -r "pk_[a-zA-Z0-9]\{20,\}" src/ 2>/dev/null; then
            echo ""
            echo "âŒ SECURITY VIOLATION: Public API key found in source code"
            echo "âš ï¸  Public keys should be in environment variables"
            echo ""
            echo "ğŸ”§ Recommended fix:"
            echo "   1. Move key to .env.local as NEXT_PUBLIC_STRIPE_KEY"
            echo "   2. Use process.env.NEXT_PUBLIC_STRIPE_KEY in code"
            echo "   3. Ensure .env.local is in .gitignore"
            echo ""
            exit 1
          fi
          echo "   âœ… No exposed public API keys found"

          # =================================================================
          # DANGEROUS CODE PATTERN DETECTION
          # =================================================================
          # Scans for patterns that can lead to XSS or code injection vulnerabilities
          # Patterns: eval(), innerHTML assignment, document.write()

          echo "âš ï¸  Checking for dangerous code patterns..."
          if grep -rE "\beval\s*\(|innerHTML\s*=|document\.write\s*\(" src/ 2>/dev/null; then
            echo ""
            echo "âŒ SECURITY VIOLATION: Dangerous code patterns detected"
            echo "ğŸ›¡ï¸  These patterns can lead to XSS vulnerabilities or code injection"
            echo ""
            echo "ğŸš« Detected dangerous patterns:"
            echo "   â€¢ eval() - Can execute arbitrary code"
            echo "   â€¢ innerHTML = - Can inject malicious HTML/JS"
            echo "   â€¢ document.write() - Can overwrite page content"
            echo ""
            echo "ğŸ”§ Safe alternatives:"
            echo "   â€¢ Use JSON.parse() instead of eval()"
            echo "   â€¢ Use textContent or createElement() instead of innerHTML"
            echo "   â€¢ Use modern DOM methods instead of document.write()"
            echo ""
            exit 1
          fi
          echo "   âœ… No dangerous code patterns found"

          echo ""
          echo "ğŸ”’ Security scanning completed successfully"
          echo "âœ… Repository is free from known security vulnerabilities"

      # =================================================================
      # DEPENDENCY INSTALLATION
      # =================================================================
      # Installs project dependencies for quality checks and build verification

      - name: "Install Project Dependencies"
        run: |
          echo "ğŸ“¦ Installing project dependencies..."
          npm ci
          echo "âœ… Dependencies installed successfully"

      # =================================================================
      # CODE QUALITY GATE
      # =================================================================
      # Enforces code quality standards through ESLint
      # Prevents commits that don't meet established coding standards

      - name: "Code Quality Enforcement"
        run: |
          echo "ğŸ§¹ Starting code quality validation..."
          echo "ğŸ“‹ Running ESLint checks for code standards..."

          npm run lint || {
            echo ""
            echo "âŒ CODE QUALITY GATE FAILED"
            echo "ğŸš¨ Your code does not meet the established quality standards"
            echo ""
            echo "ğŸ”§ To fix these issues:"
            echo "   1. Run 'npm run lint:fix' to auto-fix simple issues"
            echo "   2. Manually fix remaining lint errors"
            echo "   3. Run 'npm run lint' to verify all issues are resolved"
            echo ""
            echo "ğŸ“– Coding standards enforced:"
            echo "   â€¢ Accessibility compliance (jsx-a11y)"
            echo "   â€¢ React best practices"
            echo "   â€¢ Modern JavaScript patterns (Unicorn)"
            echo "   â€¢ Code complexity limits (SonarJS)"
            echo "   â€¢ Import organization and path consistency"
            echo ""
            exit 1
          }

          echo "âœ… Code quality checks passed"
          echo "ğŸ‰ All code meets established quality standards"

      # =================================================================
      # BUILD VERIFICATION GATE
      # =================================================================
      # Ensures code can be built successfully for production deployment
      # Prevents deployment of code that would fail in production

      - name: "Production Build Verification"
        run: |
          echo "ğŸ—ï¸  Starting production build verification..."
          echo "ğŸ”§ Testing Next.js production build process..."

          npm run build || {
            echo ""
            echo "âŒ BUILD GATE FAILED"
            echo "ğŸš¨ Code cannot be built for production deployment"
            echo ""
            echo "ğŸ” Common build failure causes:"
            echo "   â€¢ TypeScript/JSDoc type errors"
            echo "   â€¢ Missing environment variables"
            echo "   â€¢ Import/export syntax errors"
            echo "   â€¢ Missing dependencies"
            echo "   â€¢ React component errors"
            echo ""
            echo "ğŸ”§ To fix build issues:"
            echo "   1. Run 'npm run build' locally to reproduce"
            echo "   2. Fix all compilation errors"
            echo "   3. Ensure all environment variables are properly configured"
            echo "   4. Test the build in development environment"
            echo ""
            exit 1
          }

          echo "âœ… Production build verification passed"
          echo "ğŸš€ Code is ready for production deployment"

        env:
          # MongoDB connection for build-time operations
          MONGODB_URI: ${{ secrets.MONGODB_URI }}

      # =================================================================
      # DEPENDENCY VULNERABILITY SCANNING
      # =================================================================
      # Scans for high-severity vulnerabilities in project dependencies
      # Prevents deployment with known security vulnerabilities

      - name: "Dependency Security Audit"
        run: |
          echo "ğŸ” Starting dependency vulnerability scan..."
          echo "ğŸ›¡ï¸  Checking for high-severity security vulnerabilities..."

          npm audit --audit-level=high || {
            echo ""
            echo "âŒ SECURITY GATE FAILED"
            echo "ğŸš¨ High-severity vulnerabilities found in dependencies"
            echo ""
            echo "ğŸ”§ To resolve dependency vulnerabilities:"
            echo "   1. Run 'npm audit' to see detailed vulnerability report"
            echo "   2. Run 'npm audit fix' to auto-fix vulnerabilities"
            echo "   3. Update vulnerable packages to secure versions"
            echo "   4. Consider alternative packages if fixes unavailable"
            echo ""
            echo "âš ï¸  Security policy: No high-severity vulnerabilities allowed"
            echo ""
            exit 1
          }

          echo "âœ… Dependency security audit passed"
          echo "ğŸ”’ All dependencies are free from high-severity vulnerabilities"

  # =================================================================
  # JOB 2: DEVELOPMENT STANDARDS ENFORCEMENT
  # =================================================================
  # Enforces development standards and comment conventions
  # Ensures consistency in code documentation and TODO management

  enforce-standards:
    name: "Development Standards Enforcement"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Setup Node.js Environment"
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: "Install Project Dependencies"
        run: |
          echo "ğŸ“¦ Installing dependencies for standards checking..."
          npm ci

      # =================================================================
      # COMMENT STANDARDS ENFORCEMENT
      # =================================================================
      # Validates that all TODO and FIX comments follow project standards
      # Ensures proper template usage and prevents malformed comments

      - name: "TODO/FIX Comment Standards Validation"
        run: |
          echo "ğŸ“ Starting TODO/FIX comment validation..."
          echo "ğŸ” Checking all JavaScript/TypeScript files for comment standards..."
          echo ""
