name: "Auto Issue Creation"
on:
  push:
    branches: [main, staging, dev]
  workflow_dispatch:

jobs:
  todo-to-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: "TODO to Issue"
        uses: alstr/todo-to-issue-action@v5
        with:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          CLOSE_ISSUES: "true"
          AUTO_P: "false"
          # Create with no labels - we'll add professional labels in next job
          IDENTIFIERS: >
            [
              {"name": "TODO:", "labels": []}
            ]
          ISSUE_TEMPLATE: |
            {{ body }}

            ---
            **File:** {{ url }}

            **Code:**
            ```javascript
            {{ snippet }}
            ```

  apply-professional-labels:
    needs: todo-to-issue
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: "Apply Professional Labels from Automation Guide"
        run: |
          echo "üè∑Ô∏è Applying professional labels to all recent issues..."

          # Wait for TODO issues to be fully created
          sleep 30

          # Get the most recent 10 issues (regardless of age)
          echo "üîç Getting recent issues to process..."
          gh issue list --limit 10 --json number,title,body | jq -r '.[] | "\(.number)|\(.title)"' | while IFS='|' read -r number title; do
            if [[ -n "$number" && -n "$title" ]]; then
              echo ""
              echo "üìù Processing issue #$number: $title"
              
              # Get the full issue body for content analysis
              ISSUE_BODY=$(gh issue view "$number" --json body --jq '.body' 2>/dev/null || echo "")
              CONTENT="$title $ISSUE_BODY"
              
              echo "üè∑Ô∏è Adding base professional labels..."
              # Add base labels to every auto-generated issue
              gh issue edit "$number" --add-label "auto-generated" 2>/dev/null || true
              gh issue edit "$number" --add-label "type: enhancement" 2>/dev/null || true
              
              # Add AREA labels based on content (exact labels from automation guide)
              if [[ "$CONTENT" =~ (API|endpoint|route|backend|integration|Routes) ]]; then
                echo "   üîå Adding API area labels"
                gh issue edit "$number" --add-label "area: api" 2>/dev/null || true
                gh issue edit "$number" --add-label "area: backend" 2>/dev/null || true
              fi
              
              if [[ "$CONTENT" =~ (Component|hero|Dynamic|CMS|frontend|UI|design|Navbar|Footer) ]]; then
                echo "   üé® Adding frontend area labels"
                gh issue edit "$number" --add-label "area: frontend" 2>/dev/null || true
              fi
              
              if [[ "$CONTENT" =~ (database|DB|mongo|schema|model|data) ]]; then
                echo "   üóÑÔ∏è Adding database area labels"
                gh issue edit "$number" --add-label "area: database" 2>/dev/null || true
                gh issue edit "$number" --add-label "mongodb" 2>/dev/null || true
              fi
              
              if [[ "$CONTENT" =~ (payment|stripe|checkout|billing|Purchase|Cart) ]]; then
                echo "   üí≥ Adding payment area labels"
                gh issue edit "$number" --add-label "area: payment" 2>/dev/null || true
                gh issue edit "$number" --add-label "stripe" 2>/dev/null || true
                gh issue edit "$number" --add-label "priority: high" 2>/dev/null || true
              fi
              
              if [[ "$CONTENT" =~ (security|auth|login|token|password|Auth0) ]]; then
                echo "   üîí Adding security area labels"
                gh issue edit "$number" --add-label "area: security" 2>/dev/null || true
                gh issue edit "$number" --add-label "auth0" 2>/dev/null || true
                gh issue edit "$number" --add-label "priority: high" 2>/dev/null || true
              fi
              
              # Add PRIORITY labels (exact labels from automation guide)
              if [[ "$CONTENT" =~ (critical|urgent|security|payment|breaking) ]]; then
                echo "   ‚ö° Adding critical/high priority"
                if [[ "$CONTENT" =~ (critical|production.*down) ]]; then
                  gh issue edit "$number" --add-label "priority: critical" 2>/dev/null || true
                else
                  gh issue edit "$number" --add-label "priority: high" 2>/dev/null || true
                fi
              elif [[ "$CONTENT" =~ (API|integration|CMS|Version|Component|Dynamic) ]]; then
                echo "   üìã Adding medium priority"
                gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
              else
                echo "   üìù Adding low priority"
                gh issue edit "$number" --add-label "priority: low" 2>/dev/null || true
              fi
              
              # Add TECHNOLOGY labels (exact labels from automation guide)
              if [[ "$CONTENT" =~ (Next\.js|NextJS|Next) ]]; then
                gh issue edit "$number" --add-label "nextjs" 2>/dev/null || true
              fi
              
              # Add WORKFLOW labels (exact labels from automation guide)
              if [[ "$CONTENT" =~ (performance|optimize|speed|slow) ]]; then
                echo "   ‚ö° Adding performance label"
                gh issue edit "$number" --add-label "performance" 2>/dev/null || true
              fi
              
              if [[ "$CONTENT" =~ (refactor|technical.*debt|hack|legacy) ]]; then
                echo "   üîß Adding tech-debt label"
                gh issue edit "$number" --add-label "tech-debt" 2>/dev/null || true
              fi
              
              if [[ "$CONTENT" =~ (debug|console\.log|cleanup) ]]; then
                echo "   üßπ Adding cleanup label"
                gh issue edit "$number" --add-label "cleanup" 2>/dev/null || true
              fi
              
              echo "   ‚úÖ Professional labels applied to issue #$number"
              
              # Show final labels
              FINAL_LABELS=$(gh issue view "$number" --json labels --jq '.labels | map(.name) | join(", ")' 2>/dev/null || echo "Failed to get labels")
              echo "   üè∑Ô∏è Final labels: $FINAL_LABELS"
            fi
          done

          echo ""
          echo "üéâ Professional labeling complete!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  analyze-conventional-commits:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "Analyze Conventional Commit and Create Issue"
        run: |
          # Get full commit message
          FULL_COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_HASH=$(git log -1 --pretty=%H)
          AUTHOR=$(git log -1 --pretty=%an)

          echo "Analyzing conventional commit: $FULL_COMMIT_MSG"

          # Skip merge commits
          if echo "$FULL_COMMIT_MSG" | grep -q "^Merge\|^merge"; then
            echo "Skipping merge commit"
            exit 0
          fi

          # Get first line as header
          COMMIT_HEADER=$(echo "$FULL_COMMIT_MSG" | head -n1)

          # Extract type and scope using simple string parsing
          COMMIT_TYPE=""
          COMMIT_SCOPE=""
          COMMIT_SUBJECT="$COMMIT_HEADER"

          # Check if it matches conventional commit format
          if [[ "$COMMIT_HEADER" == *": "* ]]; then
            TYPE_PART="${COMMIT_HEADER%%:*}"
            COMMIT_SUBJECT="${COMMIT_HEADER#*: }"
            
            # Check for scope in parentheses
            if [[ "$TYPE_PART" == *"("*")" ]]; then
              COMMIT_TYPE="${TYPE_PART%%(*}"
              COMMIT_SCOPE="${TYPE_PART#*(}"
              COMMIT_SCOPE="${COMMIT_SCOPE%)}"
            else
              COMMIT_TYPE="$TYPE_PART"
            fi
          fi

          # Only create issues for specific commit types
          if [[ -n "$COMMIT_TYPE" ]] && [[ "$COMMIT_TYPE" =~ ^(feat|fix|perf|refactor)$ ]]; then
            
            # Create issue title
            if [[ -n "$COMMIT_SCOPE" ]]; then
              ISSUE_TITLE="[$COMMIT_TYPE($COMMIT_SCOPE)] $COMMIT_SUBJECT"
            else
              ISSUE_TITLE="[$COMMIT_TYPE] $COMMIT_SUBJECT"
            fi
            
            # Create issue body
            ISSUE_BODY="## Conventional Commit Analysis

          **Type:** \`$COMMIT_TYPE\`
          **Scope:** \`${COMMIT_SCOPE:-none}\`
          **Subject:** $COMMIT_SUBJECT

          **Commit:** $COMMIT_HASH
          **Author:** $AUTHOR

          ## Full Commit Message
          \`\`\`
          $FULL_COMMIT_MSG
          \`\`\`

          ## Analysis
          This issue was automatically created from a conventional commit to track implementation progress."
            
            # Determine labels based on commit type (using exact automation guide labels)
            LABELS="auto-generated"
            case "$COMMIT_TYPE" in
              "feat")
                LABELS="$LABELS,type: enhancement"
                ;;
              "fix"|"hotfix")
                LABELS="$LABELS,type: bug"
                ;;
              "perf")
                LABELS="$LABELS,performance"
                ;;
              "refactor")
                LABELS="$LABELS,tech-debt"
                ;;
              "docs")
                LABELS="$LABELS,type: documentation"
                ;;
              "security")
                LABELS="$LABELS,area: security,priority: critical"
                ;;
            esac
            
            # Add scope-based labels (using exact automation guide labels)
            case "$COMMIT_SCOPE" in
              "frontend"|"ui"|"components")
                LABELS="$LABELS,area: frontend"
                ;;
              "backend"|"server"|"api")
                LABELS="$LABELS,area: backend,area: api"
                ;;
              "database"|"db"|"mongo")
                LABELS="$LABELS,area: database,mongodb"
                ;;
              "auth"|"authentication"|"login")
                LABELS="$LABELS,area: security,auth0"
                ;;
              "payment"|"stripe"|"checkout")
                LABELS="$LABELS,area: payment,stripe,priority: high"
                ;;
              "cart"|"shopping")
                LABELS="$LABELS,area: frontend,area: backend"
                ;;
              "products"|"catalog")
                LABELS="$LABELS,area: database,area: api"
                ;;
              "orders"|"fulfillment")
                LABELS="$LABELS,area: backend,area: database"
                ;;
              "ci"|"workflow"|"automation")
                # CI/workflow changes are technical debt improvements
                LABELS="$LABELS,tech-debt"
                ;;
            esac
            
            # Add scope-based labels
            case "$COMMIT_SCOPE" in
              "api"|"backend")
                LABELS="$LABELS,area: api"
                ;;
              "ui"|"frontend"|"component")
                LABELS="$LABELS,area: frontend"
                ;;
              "db"|"database")
                LABELS="$LABELS,area: database"
                ;;
              "auth"|"security")
                LABELS="$LABELS,area: security"
                ;;
              "ci"|"workflow")
                LABELS="$LABELS,ci"
                ;;
            esac
            
            echo "Creating issue: $ISSUE_TITLE"
            gh issue create \
              --title "$ISSUE_TITLE" \
              --body "$ISSUE_BODY" \
              --label "$LABELS"
          else
            echo "Skipping commit type: $COMMIT_TYPE (not configured for issue creation)"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  analyze-file-changes:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "Analyze File Changes and Create Issues"
        run: |
          echo "üîç Analyzing file changes..."

          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No files changed, skipping analysis"
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Analyze significant changes
          while IFS= read -r file; do
            if [[ -n "$file" ]]; then
              echo ""
              echo "Analyzing: $file"
              
              # Check file type and determine if it needs tracking (using exact automation guide labels)
              SHOULD_CREATE_ISSUE=false
              ISSUE_TITLE=""
              ISSUE_LABELS="auto-generated"
              
              case "$file" in
                *.js|*.jsx|*.ts|*.tsx)
                  if [[ "$file" == *"component"* ]] || [[ "$file" == *"Component"* ]]; then
                    SHOULD_CREATE_ISSUE=true
                    ISSUE_TITLE="Component Update: $file"
                    ISSUE_LABELS="$ISSUE_LABELS,area: frontend,type: enhancement"
                  elif [[ "$file" == *"api"* ]] || [[ "$file" == *"API"* ]]; then
                    SHOULD_CREATE_ISSUE=true
                    ISSUE_TITLE="API Update: $file"
                    ISSUE_LABELS="$ISSUE_LABELS,area: api,area: backend,type: enhancement"
                  fi
                  ;;
                *.scss|*.sass|*.css)
                  SHOULD_CREATE_ISSUE=true
                  ISSUE_TITLE="Styling Update: $file"
                  ISSUE_LABELS="$ISSUE_LABELS,area: frontend,type: enhancement"
                  ;;
                *package.json|*package-lock.json|*yarn.lock)
                  SHOULD_CREATE_ISSUE=true
                  ISSUE_TITLE="Dependency Update: $file"
                  ISSUE_LABELS="$ISSUE_LABELS,type: enhancement,priority: low"
                  ;;
                *.md)
                  if [[ "$file" == *"README"* ]]; then
                    SHOULD_CREATE_ISSUE=true
                    ISSUE_TITLE="Documentation Update: $file"
                    ISSUE_LABELS="$ISSUE_LABELS,type: documentation"
                  fi
                  ;;
                .github/workflows/*)
                  SHOULD_CREATE_ISSUE=true
                  ISSUE_TITLE="Workflow Update: $file"
                  ISSUE_LABELS="$ISSUE_LABELS,type: enhancement,priority: medium"
                  ;;
              esac
              
              if [[ "$SHOULD_CREATE_ISSUE" == "true" ]]; then
                # Get file diff for analysis
                FILE_DIFF=$(git diff HEAD~1 HEAD -- "$file" | head -50)
                
                ISSUE_BODY="## File Change Analysis

          **File:** \`$file\`
          **Change Type:** Automatic detection

          ## Changes Made
          \`\`\`diff
          $FILE_DIFF
          \`\`\`

          ## Next Steps
          - [ ] Review changes for quality
          - [ ] Update related documentation if needed
          - [ ] Test affected functionality

          _This issue was automatically created to track significant file changes._"
                
                echo "Creating issue for: $file"
                gh issue create \
                  --title "$ISSUE_TITLE" \
                  --body "$ISSUE_BODY" \
                  --label "$ISSUE_LABELS"
              fi
            fi
          done <<< "$CHANGED_FILES"

          echo "üéâ File change analysis complete!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
