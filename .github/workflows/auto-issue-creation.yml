name: "Auto Issue Creation"
on:
  push:
    branches: [main, staging, dev]
  workflow_dispatch:

jobs:
  todo-to-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: "TODO to Issue"
        uses: alstr/todo-to-issue-action@v5
        with:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          CLOSE_ISSUES: "true"
          AUTO_P: "false"
          IDENTIFIERS: >
            [
              {"name": "TODO:", "labels": []},
              {"name": "FIX:", "labels": []}
            ]
          ISSUE_TEMPLATE: "{{ body }}\n\n---\n**File:** [{{ url }}]({{ url }})\n\n{{ snippet }}\n"

  apply-labels:
    needs: [todo-to-issue]
    if: always() && needs.todo-to-issue.result != 'failure'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: "Apply Labels to TODO Issues"
        run: |
          echo "üè∑Ô∏è Applying labels to recent TODO/FIX issues..."

          # Wait for TODO issues to be fully created
          sleep 30

          # Only process issues created in the last 5 minutes
          CUTOFF_TIME=$(date -d '5 minutes ago' --iso-8601=seconds)
          echo "üîç Looking for TODO/FIX issues created after: $CUTOFF_TIME"

          gh issue list --limit 20 --json number,title,body,createdAt | jq -r --arg cutoff "$CUTOFF_TIME" '.[] | select(.createdAt > $cutoff) | "\(.number)|\(.title)"' | while IFS='|' read -r number title; do
            if [[ -n "$number" && -n "$title" ]]; then
              echo ""
              echo "üìù Processing issue #$number: $title"
              
              # Get the commit author for assignment
              COMMIT_AUTHOR="${{ github.actor }}"
              echo "   üë§ Assigning to commit author: $COMMIT_AUTHOR"
              
              # Get the full issue body for content analysis
              ISSUE_BODY=$(gh issue view "$number" --json body --jq '.body' 2>/dev/null || echo "")
              
              # Check if this issue was created from TODO/FIX comment
              if [[ "$ISSUE_BODY" =~ \*\*File:\*\* ]] || [[ "$ISSUE_BODY" =~ \*\*Code:\*\* ]]; then
                echo "   ‚úÖ Confirmed TODO/FIX issue - validating and applying labels"
                
                # VALIDATION 1: Check for required template format
                if [[ ! "$title" =~ ^\[.*\] ]]; then
                  echo "   ‚ùå VALIDATION FAILED: Missing template prefix"
                  gh issue edit "$number" --add-label "validation-failed" 2>/dev/null || true
                  gh issue comment "$number" --body "üö´ **Validation Failed**: TODO/FIX comments must include a template prefix like [COMPONENT], [SECURITY], [DOCS], etc." 2>/dev/null || true
                  continue
                fi
                
                # Extract template for validation
                TEMPLATE=$(echo "$title" | grep -o '^\[[^]]*\]' | tr '[:lower:]' '[:upper:]')
                TEMPLATE_NAME=$(echo "$TEMPLATE" | sed 's/\[//g' | sed 's/\]//g')
                
                # VALIDATION 2: Check content length after template
                CONTENT_AFTER_TEMPLATE=$(echo "$title" | sed 's/^\[[^]]*\][[:space:]]*//')
                if [[ ${#CONTENT_AFTER_TEMPLATE} -lt 10 ]]; then
                  echo "   ‚ùå VALIDATION FAILED: Content too short (${#CONTENT_AFTER_TEMPLATE} chars, need 10+)"
                  gh issue edit "$number" --add-label "validation-failed" 2>/dev/null || true
                  gh issue comment "$number" --body "üö´ **Validation Failed**: Content after template must be at least 10 characters. Got: '${CONTENT_AFTER_TEMPLATE}' (${#CONTENT_AFTER_TEMPLATE} chars)" 2>/dev/null || true
                  continue
                fi
                
                # VALIDATION 3: Check for multiple templates
                TEMPLATE_COUNT=$(echo "$title" | grep -o '\[.*\]' | wc -l)
                if [[ $TEMPLATE_COUNT -gt 1 ]]; then
                  echo "   ‚ùå VALIDATION FAILED: Multiple templates detected ($TEMPLATE_COUNT templates)"
                  gh issue edit "$number" --add-label "validation-failed" 2>/dev/null || true
                  gh issue comment "$number" --body "üö´ **Validation Failed**: Multiple templates detected ($TEMPLATE_COUNT). Only one template allowed per comment." 2>/dev/null || true
                  continue
                fi
                
                # VALIDATION 4: Check for valid template
                VALID_TEMPLATES=(
                  "COMPONENT" "UI/UX" "ROUTES" "DATA" "SECURITY" "BUG" "PERF" 
                  "REFACTOR" "TEST" "DOCS" "DEPENDENCY" "ONBOARDING" "I18N" 
                  "A11Y" "FEATURE" "RESEARCH" "STATE" "CI" "CD" "WORKFLOW" 
                  "AUTOMATION" "ACTIONS" "DEPLOY" "BUILD"
                )
                
                VALID_TEMPLATE=false
                for valid in "${VALID_TEMPLATES[@]}"; do
                  if [[ "$TEMPLATE_NAME" == "$valid" ]]; then
                    VALID_TEMPLATE=true
                    break
                  fi
                done
                
                if [[ "$VALID_TEMPLATE" == "false" ]]; then
                  echo "   ‚ùå VALIDATION FAILED: Invalid template [$TEMPLATE_NAME]"
                  gh issue edit "$number" --add-label "validation-failed" 2>/dev/null || true
                  VALID_LIST=$(printf ", [%s]" "${VALID_TEMPLATES[@]}")
                  VALID_LIST=${VALID_LIST:2}  # Remove leading ", "
                  gh issue comment "$number" --body "üö´ **Validation Failed**: Template [$TEMPLATE_NAME] is not valid. Use one of: $VALID_LIST" 2>/dev/null || true
                  continue
                fi
                
                # VALIDATION 5: Check for non-English characters
                if echo "$title" | grep -qP '[^\x00-\x7F]'; then
                  echo "   ‚ùå VALIDATION FAILED: Non-English characters detected"
                  INVALID_CHARS=$(echo "$title" | grep -oP '[^\x00-\x7F]' | tr '\n' ' ')
                  gh issue edit "$number" --add-label "validation-failed" 2>/dev/null || true
                  gh issue comment "$number" --body "üö´ **Validation Failed**: TODO/FIX comments must use English characters only. Found: $INVALID_CHARS" 2>/dev/null || true
                  continue
                fi
                
                # VALIDATION 6: Check for special characters
                if [[ "$title" =~ [\$\`\&\|\>\<\;] ]]; then
                  echo "   ‚ùå VALIDATION FAILED: Special characters detected"
                  FOUND_CHARS=$(echo "$title" | grep -o '[\$`&|><;]' | tr '\n' ' ')
                  gh issue edit "$number" --add-label "validation-failed" 2>/dev/null || true
                  gh issue comment "$number" --body "üö´ **Validation Failed**: TODO/FIX comments cannot contain special characters: $FOUND_CHARS" 2>/dev/null || true
                  continue
                fi
                
                echo "   ‚úÖ ALL VALIDATIONS PASSED - applying labels"
                
                # Normalize template to uppercase and update title if needed
                PREFIX_PART=$(echo "$title" | grep -o '^\[[^]]*\]' | tr '[:lower:]' '[:upper:]')
                REST_OF_TITLE=$(echo "$title" | sed 's/^\[[^]]*\]//')
                NORMALIZED_TITLE="$PREFIX_PART$REST_OF_TITLE"
                
                if [[ "$NORMALIZED_TITLE" != "$title" ]]; then
                  echo "   üìù Normalizing template: $PREFIX_PART"
                  gh issue edit "$number" --title "$NORMALIZED_TITLE" 2>/dev/null || true
                  title="$NORMALIZED_TITLE"
                  TEMPLATE="$PREFIX_PART"
                  TEMPLATE_NAME=$(echo "$TEMPLATE" | sed 's/\[//g' | sed 's/\]//g')
                fi
                
                # Truncate if too long
                if [[ ${#title} -gt 80 ]]; then
                  title="${title:0:77}..."
                  gh issue edit "$number" --title "$title" 2>/dev/null || true
                fi
                
                echo "   üè∑Ô∏è Adding base labels..."
                gh issue edit "$number" --add-label "auto-generated" 2>/dev/null || true
                gh issue edit "$number" --add-label "type: enhancement" 2>/dev/null || true
                
                # Assign to commit author
                gh issue edit "$number" --add-assignee "$COMMIT_AUTHOR" 2>/dev/null || true
                
                # Extract TODO comment content for analysis (NOT entire file)
                TODO_COMMENT_LINES=""
                if [[ "$ISSUE_BODY" =~ \*\*Code:\*\* ]]; then
                  # Extract only the TODO/FIX comment lines from the code snippet
                  TODO_COMMENT_LINES=$(echo "$ISSUE_BODY" | sed -n '/```/,/```/p' | grep -E '^\s*//\s*(TODO|FIX):' | head -3)
                fi
                COMMENT_ANALYSIS_TEXT="$title $TODO_COMMENT_LINES"
                
                # Template-based labeling
                echo "   üéØ Processing template: [$TEMPLATE_NAME]"
                
                case "$TEMPLATE_NAME" in
                  "CI"|"CD"|"WORKFLOW"|"AUTOMATION"|"ACTIONS"|"DEPLOY"|"BUILD")
                    echo "     üîß CI/CD template detected"
                    gh issue edit "$number" --add-label "ci/cd" 2>/dev/null || true
                    if [[ "$TEMPLATE_NAME" =~ ^(CI|CD|DEPLOY|BUILD)$ ]]; then
                      gh issue edit "$number" --add-label "priority: high" 2>/dev/null || true
                    else
                      gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    fi
                    ;;
                  "COMPONENT"|"UI/UX")
                    echo "     üé® Frontend template detected"
                    gh issue edit "$number" --add-label "area: frontend" 2>/dev/null || true
                    gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    ;;
                  "ROUTES"|"DATA")
                    echo "     üîå API/Backend template detected"
                    gh issue edit "$number" --add-label "area: api" 2>/dev/null || true
                    gh issue edit "$number" --add-label "area: backend" 2>/dev/null || true
                    gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    ;;
                  "SECURITY")
                    echo "     üîí Security template detected"
                    gh issue edit "$number" --add-label "area: security" 2>/dev/null || true
                    gh issue edit "$number" --add-label "priority: high" 2>/dev/null || true
                    # Check if this was a FIX comment (security vulnerability)
                    if [[ "$ISSUE_BODY" =~ FIX: ]]; then
                      echo "     üêõ Security FIX - changing to bug type"
                      gh issue edit "$number" --remove-label "type: enhancement" 2>/dev/null || true
                      gh issue edit "$number" --add-label "type: bug" 2>/dev/null || true
                    fi
                    ;;
                  "BUG")
                    echo "     üêõ Bug template detected"
                    gh issue edit "$number" --remove-label "type: enhancement" 2>/dev/null || true
                    gh issue edit "$number" --add-label "type: bug" 2>/dev/null || true
                    if [[ "$ISSUE_BODY" =~ FIX: ]]; then
                      gh issue edit "$number" --add-label "priority: high" 2>/dev/null || true
                    else
                      gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    fi
                    ;;
                  "PERF")
                    echo "     ‚ö° Performance template detected"
                    gh issue edit "$number" --add-label "performance" 2>/dev/null || true
                    gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    ;;
                  "REFACTOR")
                    echo "     üîß Refactor template detected"
                    gh issue edit "$number" --add-label "tech-debt" 2>/dev/null || true
                    gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    ;;
                  "TEST")
                    echo "     üß™ Test template detected"
                    gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    ;;
                  "DOCS")
                    echo "     üìö Documentation template detected"
                    gh issue edit "$number" --remove-label "type: enhancement" 2>/dev/null || true
                    gh issue edit "$number" --add-label "type: documentation" 2>/dev/null || true
                    gh issue edit "$number" --add-label "priority: low" 2>/dev/null || true
                    ;;
                  "DEPENDENCY")
                    echo "     üì¶ Dependency template detected"
                    gh issue edit "$number" --add-label "priority: low" 2>/dev/null || true
                    ;;
                  "FEATURE")
                    echo "     ‚ú® Feature template detected"
                    gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    ;;
                  *)
                    echo "     üìã Other template: $TEMPLATE_NAME"
                    gh issue edit "$number" --add-label "priority: medium" 2>/dev/null || true
                    ;;
                esac
                
                # Technology detection (only from comment text)
                if [[ "$COMMENT_ANALYSIS_TEXT" =~ (Next\.js|NextJS|Next) ]]; then
                  echo "     ‚öõÔ∏è Next.js mentioned - adding nextjs label"
                  gh issue edit "$number" --add-label "nextjs" 2>/dev/null || true
                fi
                
                # Content-based labeling (ONLY from TODO comment, not entire file)
                if [[ "$COMMENT_ANALYSIS_TEXT" =~ (console\.log|console\s+log|alert\(|debugger) ]]; then
                  echo "     üßπ Debug code mentioned in comment - adding cleanup label"
                  gh issue edit "$number" --add-label "cleanup" 2>/dev/null || true
                fi
                
                # Only add performance label if specifically mentioned AND not already a PERF template
                if [[ "$COMMENT_ANALYSIS_TEXT" =~ (performance|optimize|optimization|speed|slow|bottleneck) ]] && [[ ! "$TEMPLATE_NAME" == "PERF" ]]; then
                  echo "     ‚ö° Performance keywords in comment - adding performance label"
                  gh issue edit "$number" --add-label "performance" 2>/dev/null || true
                fi
                
                echo "   ‚úÖ Labels applied successfully"
                
                # Show final status
                FINAL_LABELS=$(gh issue view "$number" --json labels --jq '.labels | map(.name) | join(", ")' 2>/dev/null || echo "Failed to get labels")
                echo "   üè∑Ô∏è Final labels: $FINAL_LABELS"
              else
                echo "   ‚ö†Ô∏è Not a TODO/FIX issue - skipping"
              fi
            fi
          done

          echo ""
          echo "üéâ Issue labeling complete!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
