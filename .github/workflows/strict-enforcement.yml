# =================================================================
# INFRASTRUCTURE-LEVEL ENFORCEMENT WORKFLOW
# =================================================================
# Purpose: Enforces security, quality, and standards at the CI/CD level
# Triggers: All pushes and pull requests on any branch
# Enforcement: Security scanning, code quality, build verification, TODO standards
#
# This workflow provides multiple security and quality gates:
# 1. Security scanning for sensitive data and dangerous patterns
# 2. Code quality enforcement through ESLint
# 3. Build verification to ensure deployability
# 4. Dependency vulnerability scanning
# 5. TODO/FIX comment standards enforcement
#
# These checks run on every push to prevent security issues and
# maintain code quality standards across the entire project.
# =================================================================

name: "Infrastructure-Level Enforcement"

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  security-events: write
  contents: read

jobs:
  build:
    name: "Security & Quality Gate"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: "Security Scanning"
        run: |
          echo "ğŸ”’ Starting comprehensive security scan..."
          echo "ğŸ” Scanning for sensitive data and dangerous code patterns..."

          echo "ğŸ’³ Checking for Stripe secret keys..."
          if grep -r "sk_[a-zA-Z0-9]\{20,\}" src/ 2>/dev/null; then
            echo ""
            echo "âŒ CRITICAL SECURITY VIOLATION: Stripe secret key detected"
            echo "ğŸš¨ Secret API keys must never be committed to version control"
            echo "ğŸ”§ Fix: Move to .env.local and use process.env.STRIPE_SECRET_KEY"
            exit 1
          fi
          echo "   âœ… No Stripe secret keys found"

          echo "ğŸ”‘ Checking for exposed public API keys..."
          if grep -r "pk_[a-zA-Z0-9]\{20,\}" src/ 2>/dev/null; then
            echo ""
            echo "âŒ SECURITY VIOLATION: Public API key found in source code"
            echo "âš ï¸  Public keys should be in environment variables"
            echo "ğŸ”§ Fix: Move to .env.local as NEXT_PUBLIC_STRIPE_KEY"
            exit 1
          fi
          echo "   âœ… No exposed public API keys found"

          echo "âš ï¸  Checking for dangerous code patterns..."
          if grep -rE "\beval\s*\(|innerHTML\s*=|document\.write\s*\(" src/ 2>/dev/null; then
            echo ""
            echo "âŒ SECURITY VIOLATION: Dangerous code patterns detected"
            echo "ğŸ›¡ï¸  These patterns can lead to XSS vulnerabilities or code injection"
            echo "ğŸ”§ Safe alternatives: Use JSON.parse(), textContent, or modern DOM methods"
            exit 1
          fi
          echo "   âœ… No dangerous code patterns found"

          echo ""
          echo "âœ… Security scanning completed successfully"

      - name: "Install Dependencies"
        run: npm ci

      - name: "Code Quality Gate"
        run: |
          echo "ğŸ§¹ Starting code quality validation..."
          echo "ğŸ“‹ Running ESLint checks for code standards..."

          npm run lint || {
            echo ""
            echo "âŒ CODE QUALITY GATE FAILED"
            echo "ğŸš¨ Your code does not meet the established quality standards"
            echo ""
            echo "ğŸ”§ To fix these issues:"
            echo "   1. Run 'npm run lint:fix' to auto-fix simple issues"
            echo "   2. Manually fix remaining lint errors"
            echo "   3. Run 'npm run lint' to verify all issues are resolved"
            exit 1
          }

          echo "âœ… Code quality checks passed"
          echo "ğŸ‰ All code meets established quality standards"

      - name: "Build Verification"
        run: |
          echo "ğŸ—ï¸  Starting production build verification..."
          echo "ğŸ”§ Testing Next.js production build process..."

          npm run build || {
            echo ""
            echo "âŒ BUILD GATE FAILED"
            echo "ğŸš¨ Code cannot be built for production deployment"
            echo ""
            echo "ğŸ” Common build failure causes:"
            echo "   â€¢ TypeScript/JSDoc type errors"
            echo "   â€¢ Missing environment variables"
            echo "   â€¢ Import/export syntax errors"
            echo "   â€¢ React component errors"
            echo ""
            echo "ğŸ”§ To fix build issues:"
            echo "   1. Run 'npm run build' locally to reproduce"
            echo "   2. Fix all compilation errors"
            echo "   3. Ensure all environment variables are configured"
            exit 1
          }

          echo "âœ… Production build verification passed"
          echo "ğŸš€ Code is ready for production deployment"
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}

      - name: "Dependency Vulnerability Check"
        run: |
          echo "ğŸ” Starting dependency vulnerability scan..."
          echo "ğŸ›¡ï¸  Checking for high-severity security vulnerabilities..."

          npm audit --audit-level=high || {
            echo ""
            echo "âŒ SECURITY GATE FAILED"
            echo "ğŸš¨ High-severity vulnerabilities found in dependencies"
            echo ""
            echo "ğŸ”§ To resolve dependency vulnerabilities:"
            echo "   1. Run 'npm audit' to see detailed vulnerability report"
            echo "   2. Run 'npm audit fix' to auto-fix vulnerabilities"
            echo "   3. Update vulnerable packages to secure versions"
            echo "   4. Consider alternative packages if fixes unavailable"
            echo ""
            echo "âš ï¸  Security policy: No high-severity vulnerabilities allowed"
            exit 1
          }

          echo "âœ… Dependency security audit passed"
          echo "ğŸ”’ All dependencies are free from high-severity vulnerabilities"
